name: Financial Reporting Service

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ebpf-runners-cicd
    steps:
      - uses: actions/checkout@v3

      - name: Check Kernel Version
        run: uname -r

      - name: Download kntrl (arm64)
        run: |
          curl -L -o kntrl https://github.com/kondukto-io/kntrl/releases/download/v0.1.3/kntrl_arm64.arm64
          chmod +x kntrl
          sudo mv kntrl /usr/local/bin/kntrl

      - name: Start kntrl agent (Monitor Mode)
        run: |
          echo "Starting kntrl agent in monitor mode..."
          sudo /usr/local/bin/kntrl run --mode=monitor --allowed-hosts=kondukto.io,${{ env.GITHUB_ACTIONS_URL }} --allow-local-ranges=true &
          sleep 5
          echo "kntrl agent started in background."

      - name: Secured Build
        run: |
          echo "Secure financial reporting service build on this runner"
          hostname
          env
          ls -la

  malicious-build:
    runs-on: ebpf-runners-cicd
    steps:
      - uses: actions/checkout@v3

      - name: Start kntrl agent (Prevent Mode)
        run: |
          echo "Starting kntrl agent in prevent mode..."
          sudo /usr/local/bin/kntrl run --mode=trace --allowed-hosts=kondukto.io,${{ env.GITHUB_ACTIONS_URL }} --allow-local-ranges=true &
          sleep 5
          echo "kntrl agent started in background with prevention enabled."

      - name: Simulate Malicious Actions
        run: |
          echo "Simulating malicious build trying to gain access..."
          hostname
          env
          ls -la /etc/shadow # Attempt to access a sensitive file
          mkdir /tmp/evil_dir
          echo "Malicious file created" > /tmp/evil_dir/malicious.txt
          curl -m 10 http://unauthorized-site.example.com # Attempt to connect to an external site
          echo "Attempted malicious actions."

      - name: Check kntrl Logs
        if: always()
        run: |
          echo "Checking kntrl logs..."
          if [ -f /tmp/kntrl.out ]; then
            cat /tmp/kntrl.out
          else
            echo "kntrl log file not found."
          fi